# Cold Harbor: Real-Time Trading Analytics & Risk Management


**Cold Harbor** is an integrated trading operations system for Alpaca
accounts. It maintains a local, authoritative view of account state
(positions, equity, orders) in real time, backed by PostgreSQL/TimescaleDB.

The system includes a dedicated **Risk Manager** service. It monitors open
exposure, manages stop-loss orders, and automatically trails stops to
break-even once price reaches a pre-calculated 2R volatility target.


## Preview
> **⚠️ Disclaimer:** The balances and P&L shown in this preview are not real
> money and do not represent actual brokerage balances or personal capital.
> The screenshots are taken from the system connected to the broker's
> paper-trading account with simulated funds. Orders, fills, positions,
> equity and P&L are generated by the live system, but no real capital or
> real financial assets are involved.

![Platform preview](docs/img/dashboard_preview.png)

## Tech Stack

| Domain | Technologies |
|--------|--------------|
| **Core & Async** | Python 3.12, `asyncio`, `asyncpg` (DB), ZeroMQ (Data Bus) |
| **Web & API** | Flask, Server-Sent Events (SSE), Gunicorn (`gevent`), Jinja2 |
| **Data Engineering** | PostgreSQL 16+, TimescaleDB (Time-Series), Pandas, NumPy |
| **Orchestration** | Apache Airflow (DAGs, Scheduling), `supervisord` |
| **Infrastructure** | Docker, Docker Compose, Google Cloud Run, Cloud Build |
| **Networking** | Cloudflare Access (Zero Trust Tunnels), Alpaca API (Trading) |

## System Components

The following architecture diagram summarizes the key services and data
flows:

```mermaid
graph TD
    %% Global Styles
    classDef external fill:#faf3c7,stroke:#b58900,stroke-width:2px,color:#3e1f04;
    classDef service fill:#e0f2f1,stroke:#00695c,stroke-width:2px,color:#00332a;
    classDef worker fill:#f1f8e9,stroke:#33691e,stroke-width:1px,color:#1b5e20;
    classDef db fill:#f8f4f0,stroke:#4e342e,stroke-width:2px,shape:cylinder,color:#3e2723;
    classDef bus fill:#fff8e1,stroke:#ff9800,stroke-width:2px,shape:rect,color:#e65100;

    %% =========================================================
    %% 1. EXTERNAL SOURCES (Top Left / Center)
    %% =========================================================
    subgraph External [External Market Data]
        direction TB
        AlpacaWS(Alpaca WebSocket):::external
        AlpacaREST(Alpaca REST API):::external
        ZMQ(ZMQ Price Stream):::external
        
        %% Force vertical stacking inside External
        AlpacaWS ~~~ ZMQ ~~~ AlpacaREST
    end

    %% =========================================================
    %% 2. INGESTER STACK (Right Column)
    %% =========================================================
    subgraph Ingester_Stack [Data Ingester Service]
        direction TB
        IngesterRun(<b>ingester_run.py</b>):::service
        
        %% Workers
        StreamWork(stream_consumer):::worker
        HealWork(healing_worker):::worker
        
        %% Raw DB
        subgraph Raw_DB [Raw Storage Schema]
            direction TB
            RawOrders[(raw_orders_live)]:::db
            RawActs[(raw_activities_live)]:::db
        end
        
        %% Flow within Ingester
        IngesterRun --> StreamWork
        StreamWork ~~~ HealWork
        
        %% Writes
        StreamWork --> RawOrders & RawActs
        HealWork --> RawOrders & RawActs
    end

    %% =========================================================
    %% 3. MANAGER STACK (Center Column)
    %% =========================================================
    subgraph Manager_Stack [Account Manager Service]
        direction TB
        MgrRun(<b>manager_run.py</b>):::service
        
        %% Workers
        PriceList(price_listener):::worker
        SnapLoop(snapshot_loop):::worker
        MetricsWork(metrics_worker):::worker
        EquityWork(equity_intraday_worker):::worker
        ClosedWork(closed_trades_worker):::worker
        CashFlowWork(cash_flows_worker):::worker
        
        %% Live DB
        subgraph Live_DB [Live Accounts Schema]
            direction TB
            TblLive[(open_positions)]:::db
            TblClosed[(closed_trades)]:::db
            TblMetrics[(account_metrics)]:::db
            TblEquity[(equity_tables)]:::db
            TblCash[(cash_flows)]:::db
        end

        %% Invisible links for ordering workers vertically
        MgrRun --> PriceList
        PriceList ~~~ SnapLoop
        SnapLoop ~~~ MetricsWork
        MetricsWork ~~~ EquityWork
        EquityWork ~~~ ClosedWork
        ClosedWork ~~~ CashFlowWork

        %% Internal Logic Writes
        PriceList --> TblLive
        SnapLoop --> TblLive
        MetricsWork --> TblMetrics
        EquityWork --> TblEquity
        ClosedWork --> TblClosed
        CashFlowWork --> TblCash
        
        %% Dependencies inside DB (Logic flow)
        TblLive --> MetricsWork
        TblLive --> EquityWork
        TblLive --> ClosedWork
        TblCash --> EquityWork
    end

    %% =========================================================
    %% 4. CLIENTS & ORCHESTRATION (Left Column)
    %% =========================================================
    subgraph Clients_Stack [Clients & Orchestration]
        direction TB
        RiskDAG(<b>Airflow Risk DAG</b>):::service
        Flask(<b>Flask Dashboard</b>):::service
        SSE((SSE Stream)):::bus
        
        RiskDAG ~~~ SSE ~~~ Flask
    end

    %% =========================================================
    %% CROSS-COMPONENT CONNECTIONS
    %% =========================================================

    %% --- External Inputs ---
    AlpacaWS --> StreamWork
    ZMQ --> PriceList
    
    %% [NEW] API Connections (Ingester & Manager)
    AlpacaREST -->|Healing/Backfill| HealWork
    AlpacaREST -->|Sync State| SnapLoop
    
    %% --- Manager Reading Raw Data ---
    RawOrders & RawActs -->|Replay| SnapLoop
    RawActs -->|Ingest Dividends| CashFlowWork

    %% --- Risk Manager Flow ---
    RawOrders -.->|Read History| RiskDAG
    RiskDAG -- Patch Order --> AlpacaREST

    %% --- Dashboard / Web Flow ---
    TblLive -.->|PG NOTIFY| SSE
    TblClosed -.->|PG NOTIFY| SSE
    SSE --> Flask
    
    %% [NEW] Dashboard SQL Reads
    TblMetrics --> Flask
    TblLive <-->|SQL| Flask
    TblClosed <-->|SQL| Flask
    TblEquity -->|SQL| Flask
    TblCash -->|SQL| Flask

```

### Active Risk Management
-   **Break-Even Engine:** Automatically trails Stop-Loss orders to the entry price once a position is "safe" (price > entry + trigger).
-   **Smart Triggers:** Uses pre-calculated volatility targets (e.g., 30-min breakout levels) to arm the break-even logic, ensuring stops aren't moved prematurely during noise.
-   **Session Orchestration:** An autonomous Supervisor manages the trading lifecycle, spinning up workers for Pre-Market (04:00 ET) and shutting down after Post-Market close to save resources.

### Real-Time Analytics
-   **Hybrid Pricing Model:** Simultaneously tracks **Strategy Price** (technical execution basis) and **Broker WAC** (tax/accounting basis), preventing P&L drift in decision-making.
-   **Live Greeks & Metrics:** Streaming calculation of Sharpe Ratio (Smart/Rolling), Win Rate, and Drawdown updated every 5 seconds.
-   **Intraday Equity Curve:** High-resolution (1-minute) charting that reconciles mark-to-market position values with cash flows (dividends, fees) in real-time.

### Data Integrity & Execution
-   **Deep Chain Tracing:** Resolves complex OTO/Bracket chains, tracking "Grandchild" orders through multiple replacements (e.g., user-modified stops) to maintain correct parentage.
-   **Orphan Detection:** Identifies "broken" positions where the broker reports exposure but the bot sees no active stop-loss protection.
-   **Immutable Data Lake:** A dedicated Ingester service captures every WebSocket event into a raw schema using synthetic IDs, ensuring zero data loss even during downtime.

### ⚡ Technical Architecture
-   **Event-Driven UI:** Server-Sent Events (SSE) push updates to the dashboard with sub-second latency.
-   **Secure Tunnels:** Integrated **Cloudflare Access** tunnels expose local PostgreSQL/TimescaleDB instances securely without public IPs.

---

## Getting Started

### Prerequisites
- Docker & Docker Compose.
- Access to an Alpaca Trading Account (Live or Paper).
- A Postgres+TimescaleDB instance (local or remote).

### Quick Start (Local)

> **Security Note:** This repository does not contain real API keys or passwords.
> Before running, you must create a `.env` file and a `airflow_simple_auth_passwords.json` file 
> based on the provided examples.

1.  **Configure Environment:**
    Copy the template `.env` (not included in git) and populate your credentials:
    ```bash
    ALPACA_API_KEY_LIVE=...
    ALPACA_SECRET_KEY_LIVE=...
    POSTGRESQL_LIVE_LOCAL_CONN_STRING=postgresql://user:pass@localhost:5433/db
    ```

2.  **Launch Stack:**
    ```bash
    docker compose up --build
    ```
    This spins up the *Manager* (syncing state), the *Ingester* (archiving history), and the *Web UI*.

3.  **Access Dashboard:**
    Open `http://localhost:5000` to view your account metrics.

## Packaging for reuse

This repository already exposes its core modules as a Python package
named `coldharbor_manager`. Run `pip install .` (or `pip install -e .`
for editable installs) from the project root to make the package
available to other applications. The package simply extends the legacy
`coldharbour_manager` directory, so clients can import either
`coldharbor_manager.services.account_manager` or the legacy path
`coldharbour_manager.services.account_manager`, whichever suits their code
base.

## Documentation

For deep dives into specific subsystems, refer to the `docs/` directory:

### Core Logic & Trading
-   [**Core Analytics**](docs/core_analytics.md): Trade matching engines (FIFO vs. Lot), GTC expiration logic, and Chain Tracing.
-   [**Risk Manager**](docs/risk_manager.md): Break-even algorithms and Airflow DAG scheduling.
-   [**Account Manager**](docs/account_manager.md): The state machine, background workers, and session supervisor.

### Data & Infrastructure
-   [**Data Ingester**](docs/ingester.md): The immutable data lake, healing strategies, and backfill logic.
-   [**Infrastructure**](docs/infrastructure.md): Cloudflare tunnels, Docker containers, and CI/CD pipelines.

### Operations & UI
-   [**Web Architecture**](docs/web_architecture.md): Flask blueprints, SSE streaming, and caching layers.
-   [**Frontend Logic**](docs/frontend_logic.md): JavaScript state management for the dashboard (`account_positions.html`).
-   [**Operations Guide**](docs/operations_guide.md): Adding new destinations, environment variables, and troubleshooting.

## Deployment

The system is designed for **Google Cloud Run**. The `cloudbuild.yaml` pipeline builds the container and deploys it with secrets injected from Secret Manager. `entrypoint.sh` automatically handles Cloudflare Tunnel initialization before starting the application.

## Contributing

Please refer to [`CONTRIBUTING.md`](CONTRIBUTING.md) for branch naming conventions and Pull Request workflows.
